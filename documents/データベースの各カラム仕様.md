## データベースの各カラム仕様
このドキュメントでは、各テーブルの各カラムがどのような仕様となっているかを解説します。略記のため、型に?を付けてNULLを許容することを表しています。

テーブルの設計方針として、キャラクターに対するキャラクター名など、1:1の対応で扱えるものについては1つのテーブルにまとめて、キャラクターに対するタグなど、1:Nの対応になりうるものは別テーブルに正規化して設計するようにしています。また、原則として文字列型を扱うカラムはTEXT型としています。

### charactersテーブル
キャラクター情報のうち、1:1の対応で扱えるものについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| ENo | INT? | キャラクターの登録番号です。登録時、実際に登録してみて何キャラ目に登録されたかを検索してからこのカラムは設定されます。そのためNULLを許容していますが、原則としてNULLがそれ以外のタイミングで設定されることはありません。また、管理者アカウントでは通常ENo.0以下を設定するため、負の整数を許容します。 |
| password | TEXT | ハッシュ化後のパスワードです。クライアント側、サーバー側両方でハッシュ処理を行っています。 |
| token | TEXT | CSRFトークンです。利便性及び定期ゲームが対応するべきセキュリティの程度を鑑みて、CSRFトークンはアカウント作成時以降固定される仕様となっています。 |
| name | TEXT | キャラクター名です。 |
| nickname | TEXT | キャラクターの短縮名です。 |
| summary | TEXT | キャラクターリストで表示される短い文章です。 |
| profile | TEXT | キャラクターのプロフィール文です。 |
| webhook | TEXT | Discord通知の通知先となるWebhookのURLです。 |
| AP | INT UNSIGNED | 現在の所持APです。APを使って各種行動を行うことができます。 |
| NP | INT UNSIGNED | 現在の所持NPです。各ステータスに割り振ることができます。 |
| ATK | INT UNSIGNED | 現在のATKの値です。 |
| DEX | INT UNSIGNED | 現在のDEXの値です。 |
| MND | INT UNSIGNED | 現在のMNDの値です。 |
| AGI | INT UNSIGNED | 現在のAGIの値です。 |
| DEF | INT UNSIGNED | 現在のDEFの値です。 |
| additional_icons | INT UNSIGNED | 追加で登録できるアイコンの数です。 |
| deleted | BOOLEAN | キャラクターが削除されているかどうかのフラグです。trueがセットされている場合このキャラクターは削除されている扱いとし、各種表示に出ないようにします。一部、削除状態でも表示したままにしたほうがよいもの等については削除扱いでも表示します（返信先表示など）。 |
| administrator | BOOLEAN | 管理者かどうかのフラグです。trueの場合管理者扱いとなり、control-panel以下のページへのアクセス等の管理者操作が可能になります。 |
| notification_replied | BOOLEAN | 返信があった際にサイト上で通知を行うかどうかの設定値です。 |
| notification_new_arrival | BOOLEAN | 購読中のトークルームに新規発言があった際にサイト上で通知を行うかどうかの設定値です。 |
| notification_faved | BOOLEAN | お気に入りされた際にサイト上で通知を行うかどうかの設定値です。 |
| notification_webhook_replied | BOOLEAN | 返信があった際にDiscordで通知を行うかどうかの設定値です。 |
| notification_webhook_new_arrival | BOOLEAN | 購読中のトークルームに新規発言があった際にDiscordで通知を行うかどうかの設定値です。 |
| notification_webhook_faved | BOOLEAN | お気に入りされた際にDiscordで通知を行うかどうかの設定値です。 |
| notificatons_last_checked_at | TIMESTAMP | 通知を最後に確認した日時です。キャラクター作成時は2000年1月1日がセットされています。一部の通知は通知を確認していない間の通知をまとめるため、その処理に使用されます。 |

### characters_tagsテーブル
各キャラクターのタグについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| ENo | INT | タグの付与先のキャラクターのENoです。 |
| tag | TEXT | 付与されるタグです。 |

### characters_iconsテーブル
各キャラクターのアイコンについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| ENo | INT | 該当のアイコンを登録しているキャラクターのENoです。 |
| name | TEXT | アイコン名です。 |
| url | TEXT | アイコンのURLです。 |

### characters_profile_imagesテーブル
各キャラクターのプロフィール画像について記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| ENo | INT | 該当のプロフィール画像を登録しているキャラクターのENoです。 |
| url | TEXT | アイコンのURLです。 |

### characters_favsテーブル
各キャラクターのお気に入りしているキャラクターについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| faver | INT | お気に入りしている側のキャラクターのENoです。 |
| faved | INT | お気に入りされている側のキャラクターのENoです。 |

### characters_mutesテーブル
各キャラクターのミュートしているキャラクターについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| muter | INT | ミュートしている側のキャラクターのENoです。 |
| muted | INT | ミュートされている側のキャラクターのENoです。 |

### characters_blocksテーブル
各キャラクターのブロックしているキャラクターについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| blocker | INT | ブロックしている側のキャラクターのENoです。 |
| blocked | INT | ブロックされている側のキャラクターのENoです。 |

### roomsテーブル
トークルーム情報のうち、1:1の対応で扱えるものについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| RNo | INT? | トークルームの登録番号です。作成時、実際に作成してみて何番目に作成されたかを検索してからこのカラムは設定されます。そのためNULLを許容していますが、原則としてNULLがそれ以外のタイミングで設定されることはありません。また、公共トークルームでは通常RNo.0以下を設定するため、負の整数を許容します。 |
| administrator | INT? | トークルームの管理者となるキャラクターのENoです。公式トークルームではNULLが設定されます。 |
| title | TEXT | トークルームのタイトルです。 |
| summary | TEXT | トークルームのタイトルです。 |
| description | TEXT | トークルームの説明文です。 |
| created_at | TIMESTAMP | トークルームが作成された日時です。 |
| last_posted_at | TIMESTAMP | トークルームの最終投稿日時です。 |
| deleted | BOOLEAN | トークルームが削除されているかどうかのフラグです。trueがセットされている場合このトークルームは削除されている扱いとし、各種表示に出ないようにします。 |
| official | BOOLEAN | 公式トークルームかどうかのフラグです。trueの場合公式トークルーム、falseの場合ユーザーの作成したトークルームです。 |

### rooms_tagsテーブル
各トークルームのタグについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| RNo | INT | タグの付与先のトークルームのRNoです。 |
| tag | TEXT | 付与されるタグです。 |

### rooms_subscribersテーブル
各トークルームの購読者について記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| RNo | INT | 対象となるトークルームのRNoです。 |
| subscriber | INT | 購読者となるキャラクターのENoです。 |

### messagesテーブル
各トークルームの発言について記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| RNo | INT | 発言が行われたトークルームのRNoです。 |
| ENo | INT | 発言を行ったキャラクターのENoです。 |
| refer | INT? UNSIGNED | 返信先となる発言のidです。NULLの場合、発言が返信ではないことを表します。 |
| refer_root | INT? UNSIGNED | 返信を辿っていった大元の発言のidです。NULLの場合、発言が返信ではないことを表します。 |
| icon | TEXT | 発言時のアイコンのURLです。 |
| name | TEXT | 発言時の名前です。 |
| message | TEXT | 発言の内容です。 |
| deleted | BOOLEAN | 発言が削除されているかどうかのフラグです。trueがセットされている場合この発言は削除されている扱いとし、各種表示に出ないようにします。 |
| posted_at | TIMESTAMP | 発言が行われた日時です。 |

### messages_recipientsテーブル
各発言の返信先について記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| message | INT UNSIGNED | 対象となる発言のidです。 |
| ENo | INT | 返信先となるキャラクターのENoです。発言者自身も返信先に含みます。 |

### notificationsテーブル
各キャラクターに送られた通知について記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| ENo | INT? | 通知の送信先キャラクターのENoです。NULLの場合、全てのキャラクターに送られた通知であることを表します。 |
| type | ENUM | 通知タイプです。`announcement`はお知らせの更新、`administrator`は管理者メッセージ、`replied`は返信されたこと、`new_arrival`は購読中のトークルームに新規の発言があったこと、`faved`はお気に入りされたこと、`direct_message`はダイレクトメッセージを受け取ったことを表します。 |
| target | INT? UNSIGNED | 通知の対象を表します。通知対象によって表す値は変わり、`replied`では返信が行われた発言のidを、`new_arrival`では発言が行われたトークルームのRNoを、`faved`ではお気に入りを行ったキャラクターのENoを、`direct_message`ではダイレクトメッセージのidを表します。対象が存在しない通知タイプではNULLとなります。 |
| count | INT? UNSIGNED | 通知のカウントを表します。一部の通知タイプでは通知を見ていない間に行われた同一の通知はまとめられます。`new_arrival`では通知を見ていない間に行われた新規の発言数を表します。カウントが存在しない通知タイプではNULLとなります。 |
| message | TEXT | 通知の内容です。 |
| notificated_at | TIMESTAMP | 通知が行われた日時です。未来の日時が登録されている場合、予約投稿として各種表示を行わないようにします。 |

### direct_messagesテーブル
ダイレクトメッセージについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| from | INT | ダイレクトメッセージの送信元となるキャラクターのENoです。 |
| to | INT | ダイレクトメッセージの送信先となるキャラクターのENoです。 |
| message | TEXT | ダイレクトメッセージの内容です。 |
| sended_at | TIMESTAMP | ダイレクトメッセージの送信日時です。 |

### threadsテーブル
各フォーラムのスレッドについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| title | TEXT | スレッドのタイトルです。 |
| name | TEXT | スレッドの投稿者名です。 |
| identifier | TEXT | 発言を識別するためのIDです。 |
| message | TEXT | スレッドの本文です。 |
| secret | TEXT | スレッドの秘匿送信内容です。これで送られた内容は管理者のみ確認できます。主にプレイ環境を送信するためのものです。 |
| password | TEXT | 編集パスワードです。クライアント側、サーバー側両方でハッシュ処理を行っています。 |
| created_at | TIMESTAMP | スレッドの作成日時です。 |
| updated_at | TIMESTAMP | スレッドの内容、タイトル、ステータス等の更新日時です。 |
| last_posted_at | TIMESTAMP | スレッドの最終投稿日時です。 |
| administrator | BOOLEAN | スレッドを立てたのが管理者かどうかのフラグです。 |
| board | ENUM | スレッドの属する掲示板です。`community`であれば交流掲示板、`bug`であれば不具合掲示板を表します。 |
| state | ENUM | スレッドの現在の状態です。`open`であれば開かれたスレッド、`closed`であれば対応済みのスレッド、`deleted`であれば削除済のスレッドを表します。`deleted`がセットされている場合このスレッドは削除されている扱いとし、各種表示に出ないようにします。 |

### threads_responsesテーブル
スレッドへのレスについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| thread | INT UNSIGNED | レスが行われたスレッドのidです。 |
| name | TEXT | レスの投稿者名です。ソフトウェア側の処理で空文字列、改行、32文字を超える文字列を許容しないようになっています。 |
| identifier | TEXT | 発言を識別するためのIDです。 |
| message | TEXT | レスの本文です。ソフトウェア側の処理で空文字列、2000文字を超える文字列を許容しないようになっています。 |
| secret | TEXT | レスの秘匿送信内容です。これで送られた内容は管理者のみ確認できます。主にプレイ環境を送信するためのものです。 |
| password | TEXT | 編集パスワードです。クライアント側、サーバー側両方でハッシュ処理を行っています。 |
| deleted | BOOLEAN | レスが削除されているかどうかのフラグです。trueがセットされている場合このレスは削除されている扱いとし、各種表示に出ないようにします。 |
| administrator | BOOLEAN | レスを行ったのが管理者かどうかのフラグです。 |
| posted_at | TIMESTAMP | レスの投稿日時です。 |
| updated_at | TIMESTAMP | レスの更新日時です。 |

### announcementsテーブル
お知らせについて記録するテーブルです。
| カラム | 型 | 仕様 |
| --- | --- | --- |
| id | INT UNSIGNED | サロゲートキーです。 |
| title | TEXT | お知らせのタイトルです。 |
| message | TEXT | お知らせの内容です。 |
| announced_at | TIMESTAMP | お知らせが行われた日時です。未来の日時が登録されている場合、予約投稿として各種表示を行わないようにします。 |